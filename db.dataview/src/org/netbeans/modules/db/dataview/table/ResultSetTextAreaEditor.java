/*
 * ResultsetEditorDialog.java
 *
 * Created on December 18, 2008, 3:07 PM
 */
package org.netbeans.modules.db.dataview.table;

import java.awt.Toolkit;
import java.awt.dnd.DropTarget;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTextArea;
import javax.swing.event.CaretEvent;
import javax.swing.event.CaretListener;
import javax.swing.text.AttributeSet;
import javax.swing.text.PlainDocument;
import org.netbeans.modules.db.dataview.meta.DBColumn;
import org.openide.windows.WindowManager;

/**
 *
 * @author  Shankari
 */
public class ResultSetTextAreaEditor extends javax.swing.JDialog {

    JTable table;
    JTextArea textArea;
    int row, column;
    boolean editable;
    Object partialValue;
    int limit;

    public ResultSetTextAreaEditor(boolean editable, JTable table, Object partialValue, int row, int column) {
        super(WindowManager.getDefault().getMainWindow(), true);
        this.table = table;
        this.row = row;
        this.column = column;
        this.editable = editable;
        this.partialValue = partialValue;
        DBColumn dbCol = ((ResultSetJXTable) table).getDBColumn(column);
        limit = dbCol.getPrecision();

        initComponents();
        initTextArea();
        if (!editable) {
            okBtn.setEnabled(false);
        }
        updateTextField();
        MaxField.setText(String.valueOf(limit));
        pack();
    }

    private void initTextArea() {
        textArea = new JTextArea(10, 50);
        textArea.setDragEnabled(editable);
        textArea.setDropTarget(new DropTarget(this, new TextComponentDropTargetListener(limit, textArea)));
        textArea.setDocument(new FixedSizePlainDocument());

        textArea.addCaretListener(new CaretListener() {

            public void caretUpdate(CaretEvent caretEvent) {
                updateTextField();
            }
        });
        String text = null;
        if (partialValue != null) {
            text = (String) partialValue;
        } else {
            Object value = table.getValueAt(row, column);
            if (value != null) {
                text = (String) value;
            }
        }
        textArea.setText(text);
        textArea.setEditable(editable);
        JScrollPane pane = new JScrollPane(textArea);
        txtPanel.add(pane, java.awt.BorderLayout.CENTER);
        textArea.addKeyListener(new TextAreaKeyListener());
    }

    private void updateTextField() {
        if (textArea.getText() != null) {
            jLabel1.setText(String.valueOf(textArea.getText().length()));
        } else {
            jLabel1.setText("0");
        }
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        lengthLabel = new javax.swing.JLabel();
        emptyLabel = new javax.swing.JLabel();
        maxLabel = new javax.swing.JLabel();
        MaxField = new javax.swing.JTextField();
        txtPanel = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        okBtn = new javax.swing.JButton();
        cancelBtn = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Column Viewer  "+table.getColumnName(column));
        setLocationByPlatform(true);
        setResizable(false);

        jPanel1.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 20, 1, 20));
        jPanel1.setMaximumSize(new java.awt.Dimension(100, 100));
        jPanel1.setMinimumSize(new java.awt.Dimension(100, 100));

        jLabel1.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.jLabel1.text")); // NOI18N
        jPanel1.add(jLabel1);

        lengthLabel.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.lengthLabel.text")); // NOI18N
        lengthLabel.setMaximumSize(new java.awt.Dimension(125, 20));
        lengthLabel.setMinimumSize(new java.awt.Dimension(125, 20));
        lengthLabel.setPreferredSize(new java.awt.Dimension(125, 20));
        jPanel1.add(lengthLabel);

        emptyLabel.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.emptyLabel.text")); // NOI18N
        emptyLabel.setMaximumSize(new java.awt.Dimension(10, 20));
        emptyLabel.setMinimumSize(new java.awt.Dimension(10, 20));
        emptyLabel.setPreferredSize(new java.awt.Dimension(10, 20));
        jPanel1.add(emptyLabel);

        maxLabel.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.maxLabel.text")); // NOI18N
        maxLabel.setMaximumSize(new java.awt.Dimension(125, 20));
        maxLabel.setMinimumSize(new java.awt.Dimension(125, 20));
        maxLabel.setPreferredSize(new java.awt.Dimension(125, 20));
        jPanel1.add(maxLabel);

        MaxField.setEditable(false);
        MaxField.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.MaxField.text")); // NOI18N
        MaxField.setMaximumSize(new java.awt.Dimension(50, 20));
        MaxField.setMinimumSize(new java.awt.Dimension(50, 20));
        MaxField.setPreferredSize(new java.awt.Dimension(50, 20));
        jPanel1.add(MaxField);

        getContentPane().add(jPanel1, java.awt.BorderLayout.NORTH);

        txtPanel.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 10, 1, 10));
        txtPanel.setLayout(new java.awt.BorderLayout());
        getContentPane().add(txtPanel, java.awt.BorderLayout.CENTER);

        jPanel2.setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 20, 1, 20));
        jPanel2.setMaximumSize(new java.awt.Dimension(100, 100));
        jPanel2.setMinimumSize(new java.awt.Dimension(100, 100));

        okBtn.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.okBtn.text")); // NOI18N
        okBtn.setMaximumSize(new java.awt.Dimension(100, 25));
        okBtn.setMinimumSize(new java.awt.Dimension(100, 25));
        okBtn.setPreferredSize(new java.awt.Dimension(100, 25));
        okBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                okBtnActionPerformed(evt);
            }
        });
        jPanel2.add(okBtn);

        cancelBtn.setText(org.openide.util.NbBundle.getMessage(ResultSetTextAreaEditor.class, "ResultSetTextAreaEditor.cancelBtn.text")); // NOI18N
        cancelBtn.setMaximumSize(new java.awt.Dimension(100, 25));
        cancelBtn.setMinimumSize(new java.awt.Dimension(100, 25));
        cancelBtn.setPreferredSize(new java.awt.Dimension(100, 25));
        cancelBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cancelBtnActionPerformed(evt);
            }
        });
        jPanel2.add(cancelBtn);

        getContentPane().add(jPanel2, java.awt.BorderLayout.SOUTH);

        pack();
    }// </editor-fold>//GEN-END:initComponents

private void okBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_okBtnActionPerformed
    table.setValueAt(textArea.getText(), row, column);
    dispose();
}//GEN-LAST:event_okBtnActionPerformed

private void cancelBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelBtnActionPerformed
    dispose();
}//GEN-LAST:event_cancelBtnActionPerformed
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField MaxField;
    private javax.swing.JButton cancelBtn;
    private javax.swing.JLabel emptyLabel;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JLabel lengthLabel;
    private javax.swing.JLabel maxLabel;
    private javax.swing.JButton okBtn;
    private javax.swing.JPanel txtPanel;
    // End of variables declaration//GEN-END:variables
    private class TextAreaKeyListener implements KeyListener {

        public void keyTyped(KeyEvent e) {
            updateTextField();
        }

        public void keyPressed(KeyEvent e) {
            updateTextField();
        }

        public void keyReleased(KeyEvent e) {
            updateTextField();
        }
    }

    class FixedSizePlainDocument extends PlainDocument {

        @Override
        public void insertString(int offs, String str, AttributeSet a) {
            try {
                if ((getLength() + str.length()) > limit) {
                    str = str.substring(0, limit);
                }
                super.insertString(offs, str, a);
            } catch (Exception e) {
                Toolkit.getDefaultToolkit().beep();
            }
        }
    }
}
