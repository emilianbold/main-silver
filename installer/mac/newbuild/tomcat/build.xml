<?xml version="1.0" encoding="UTF-8"?>

<project name="tomcat" basedir="." default="build-pkg">

    <property name="builddir" value="${basedir}/build"/>
    <property name="appdir" value="${builddir}/app"/>
    <property name="scriptsdir" value="${builddir}/scripts"/>

    <target name="clean">
        <delete dir="${builddir}"/>
    </target>

    <target name="init">
        <mkdir dir="${appdir}"/>
        <mkdir dir="${scriptsdir}"/>
    </target>

    
    <target name="get-bits">
        <echo message="Downloading Tomcat from ${tomcat_location}" />
        <get src="${tomcat_location}" dest="./build/tomcat_image.zip" usetimestamp="true"/>
    </target>
    
    <target name="unzip" depends="get-bits">
        <echo message="Unzipping Tomcat" />
        <exec executable="sh" failonerror="yes">
            <arg value="-c"/>
            <arg value="cd ${builddir} ; unzip tomcat_image.zip -d ${appdir}; rm ${builddir}/tomcat_image.zip"/>
        </exec>
        <!-- move stuff one level up -->
        <exec executable="sh" failonerror="yes">
            <arg value="-c"/>
            <arg value="cd ${appdir} ; mv apache-tomcat-*/* . ; rmdir apache-tomcat-*"/>
        </exec>
        <!-- make sure all bin/*.sh files has executable permissions-->
        <exec executable="sh" failonerror="yes">
          <arg value="-c"/>
          <arg value="cd ${appdir} ; chmod a+x bin/*.sh"/>
        </exec>        
    </target>

    <target name="build-pkg" depends="clean, init, unzip">
        <exec executable="sh" failonerror="yes" outputproperty="size">
            <arg value="-c"/>
            <arg value="du -sk build | sed 's/[\t]*build//'"/>
        </exec>        
        <echo message="sizeof.tomcat=${size}${line.separator}" file="${basedir}/../build/sizes.pro" append="true"/>   
        
        <echo message="Executing pack200 in ${appdir}"/>
        <exec executable="sh" failonerror="yes">
            <arg value="-c"/>
            <arg value='sh ${basedir}/../pack200.sh ${appdir} ${VerifyFile.class.name} ${VerifyFile.classpath}'/>
        </exec>                     
        
        <copy  todir="${scriptsdir}">
            <fileset dir="${basedir}/pkg/scripts"/>
        </copy>
        
        <copy file="${basedir}/../commonfiles/unpack200.sh" tofile="${scriptsdir}/unpack200.sh"/>
        <copy file="${basedir}/../commonfiles/get_current_jdk.sh" tofile="${scriptsdir}/get_current_jdk.sh"/>
        <copy file="${basedir}/../netBeans/baseide/build/scripts/env.sh" tofile="${scriptsdir}/env.sh"/>
        <copy file="${basedir}/../netBeans/baseide/pkg/scripts/addproduct_id.sh" tofile="${scriptsdir}/addproduct_id.sh"/>
        <copy file="${basedir}/../netBeans/baseide/pkg/scripts/add_tc.sh" tofile="${scriptsdir}/add_tc.sh"/>
        <copy file="${basedir}/../netBeans/baseide/pkg/scripts/perm.sh" tofile="${scriptsdir}/perm.sh"/>

        <chmod dir="${scriptsdir}" perm="ugo+x" includes="**/*"/>
        
        <echo message="Building tomcat-${tomcat.id}.pkg into ${basedir}/../build/tomcat-${tomcat.id}.pkg"/>
        <exec executable="sh" failonerror="yes">
            <arg value="-c"/>
            <arg value="cd ${basedir} ; pkgbuild --root ${appdir} --scripts ${scriptsdir} --identifier tomcat --install-location ${install.dir}/apache-tomcat-${tomcat.id} ${basedir}/../build/tomcat-${tomcat.id}.pkg"/>
        </exec>
    </target>
</project>
