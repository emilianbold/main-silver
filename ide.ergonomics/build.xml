<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="netbeans" name="ide.ergonomics">
    <description>Builds, tests, and runs the project org.netbeans.modules.ide.ergonomics</description>
    <import file="../nbbuild/templates/projectized.xml"/>
    <property name="anttasks.jar" value="${nb_all}/nbbuild/nbantext.jar"/>

    <target name="-release.dir" depends="-disable-kits,projectized-common.-release.dir"/>
    <target name="jar-prep" depends="-generate-proxies,projectized-common.jar-prep"/>
    <target name="clean" depends="-clean-release,projectized-common.clean"/>

    <!--
    -
    - Internal implementation
    -
    -->
    <target name="-compile-ant" depends="projectized-common.basic-init">
        <mkdir dir="${src-ant.build}"/>
        <depend srcdir="src-ant" destdir="${src-ant.build}" cache="build/depcache-ant">
            <classpath>
                <path path="${src-ant.cp}"/>
            </classpath>
        </depend>
        <javac srcdir="src-ant" destdir="${src-ant.build}"
            deprecation="${build.compiler.deprecation}"
            debug="true"
            source="1.6" target="1.6" includeantruntime="false">
            <classpath>
                <path path="${src-ant.cp}"/>
            </classpath>
            <compilerarg line="${javac.compilerargs}"/>
        </javac>
        <copy todir="${src-ant.build}">
            <fileset dir="src-ant" excludes="${jar-excludes}"/>
        </copy>
        <taskdef name="extractlayer"
             classname="org.netbeans.modules.ide.ergonomics.ant.ExtractLayer"
             classpath="${src-ant.build}:${src-ant.cp}"/>
        <taskdef name="resolvelist"
             classname="org.netbeans.nbbuild.ResolveList"
             classpath="${anttasks.jar}"/>
    </target>

    <target name="-init-clusters">
        <resolvelist
            name="ergonomic.clusters.includes"
            list="${nb.clusters.list}"
        >
            <mapper type="glob" from="*" to="*.dir"/>
        </resolvelist>
        <dirset 
            id="ergonomic.clusters"
            dir="${netbeans.dest.dir}"
            includes="${ergonomic.clusters.includes}"
        >
            <exclude name="harness"/>
            <exclude name="ide"/>
            <exclude name="platform"/>
            <exclude name="ergonomics"/>
            <exclude name="extra"/>
            <exclude name="nb"/>
        </dirset>
    </target>

    <target name="-clean-release">
        <property name="build.release.dir" location="build/release"/>
        <delete dir="${build.release.dir}"/>
    </target>
    <target name="-init-static-analysis">
        <property name="build.release.dir" location="build/release"/>
        <condition property="skip.static.analysis">
            <and>
                <equals arg1="${static.analysis}" arg2="false"/>
                <available file="${build.release.dir}"/>
            </and>
        </condition>
    </target>

    <!--
    - multi cluster operations
    -->
    <target 
        name="-disable-kits"
        depends="-init-clusters,-init-static-analysis"
        unless="skip.static.analysis"
    >
        <mkdir dir="${build.release.dir}/config/Modules"/>
        <subant genericantfile="build.xml" target="-disable-one-cluster">
            <property name="xmldir" value="${build.release.dir}/config/Modules"/>
            <property name="ergonomicsdir" location="${basedir}"/>
            <property name="src-ant.cp" value="${src-ant.cp}"/>
            <dirset refid="ergonomic.clusters"/>
        </subant>
        <pathconvert property="extra.module.files" pathsep=",">
            <path>
                <fileset id="-disable-kits" dir="${build.release.dir}">
                    <include name="**/*"/>
                </fileset>
            </path>
            <chainedmapper>
                <flattenmapper/>
                <globmapper from="*" to="config/Modules/*"/>
            </chainedmapper>
        </pathconvert>
        <copy todir="${cluster}">
            <fileset dir="${build.release.dir}">
                <include name="${extra.module.files}"/>
            </fileset>
        </copy>
    </target>

    <target 
        name="-generate-proxies"
        depends="-init-clusters,-init-static-analysis,-compile-ant"
        unless="skip.static.analysis"
    >
        <subant genericantfile="build.xml" target="-proxy-one-cluster">
            <property name="ergonomicsdir" location="${basedir}"/>
            <property name="src-ant.cp" value="${src-ant.cp}"/>
            <property name="cluster.entries" location="${netbeans.dest.dir}"/>
            <dirset refid="ergonomic.clusters"/>
        </subant>
    </target>

    <!--
    - single cluster operations
    -->
    <target name="-proxy-one-cluster">
        <property name="cluster" location="."/>
        <pathconvert property="cluster.name">
            <path location="${cluster}"/>
            <mapper type="regexp" from=".*[/\\]([a-z]*)[0-9\.]*" to="\1"/>
        </pathconvert>
        <property name="proxytmp" value="${ergonomicsdir}/build/proxies/${cluster.name}"/>
        <property name="proxydir" value="${ergonomicsdir}/build/classes/org/netbeans/modules/ide/ergonomics/${cluster.name}"/>
        <property name="cluster.properties" value="${ergonomicsdir}/${cluster.name}.properties"/>
        <available
            file="${cluster.properties}" value="${cluster.properties}" property="proxyprop"
        />
        <property name="proxyprop" location="${ergonomicsdir}/empty.properties"/>
        <property name="cluster.entries" location="${cluster}"/>
        <mkdir dir="${proxydir}"/>
        <extractlayer
            clusterName="${cluster.name}"
            bundle="${proxydir}/Bundle.properties"
            destdir="${proxydir}"
        >
           <modules dir="${cluster}">
                <include name="modules/*.jar"/>
            </modules>
           <entries dir="${cluster.entries}">
                <include name="**/modules/*.jar"/>
                <exclude name="ergonomics*/**/*"/>
            </entries>
            <bundlefilter>
                <concatfilter prepend="${proxyprop}"/>
            </bundlefilter>
         </extractlayer>
    </target>


    <target name="-disable-one-cluster">
        <property name="cluster.to.process" location="."/>
        <mkdir dir="${xmldir}"/>
        <createmodulexml xmldir="${xmldir}">
            <disabled dir="${cluster.to.process}">
                <and>
                    <filename name="modules/*.jar"/>
                    <custom
                        classname="org.netbeans.nbbuild.ModuleStateSelector"
                        classpath="${anttasks.jar}"
                    >
                        <param name="acceptEnabled" value="true"/>
                    </custom>
                </and>
            </disabled>
        </createmodulexml>
    </target>
</project>
